services:
  yt-api-mock:
    image: ghcr.io/yuge42/yt-api-mock/server:dev-d0618fd
    ports:
      - "50051:50051"
    environment:
      - LOG_LEVEL=info
    networks:
      - yt-test

  tests:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    depends_on:
      - yt-api-mock
    environment:
      - SERVER_ADDRESS=yt-api-mock:50051
      - FETCHER_BINARY=/fetcher/yt-comment-fetcher
    networks:
      - yt-test
    volumes:
      - ./reports:/tests/reports
      - ./logs:/tests/logs
    # Add a small delay to let the server start before running tests
    command: sh -c "sleep 3 && npm test"

networks:
  yt-test:
    driver: bridge
