services:
  yt-api-mock:
    image: ghcr.io/yuge42/yt-api-mock/server:dev-d0618fd
    ports:
      - "50051:50051"
    environment:
      - LOG_LEVEL=info
    networks:
      - yt-test

  tests:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    depends_on:
      - yt-api-mock
    environment:
      - SERVER_ADDRESS=yt-api-mock:50051
      - FETCHER_BINARY=/fetcher/yt-comment-fetcher
    networks:
      - yt-test
    volumes:
      - ./reports:/tests/reports
      - ./logs:/tests/logs
    # Wait for server to be accessible before running tests
    command: >
      sh -c "
        echo 'Waiting for yt-api-mock to be ready...';
        max_attempts=30;
        attempt=0;
        while [ $$attempt -lt $$max_attempts ]; do
          if nc -z yt-api-mock 50051 2>/dev/null; then
            echo 'yt-api-mock is ready!';
            npm test;
            exit $$?;
          fi;
          attempt=$$((attempt + 1));
          echo 'Waiting for yt-api-mock... (attempt '$$attempt'/'$$max_attempts')';
          sleep 1;
        done;
        echo 'ERROR: yt-api-mock did not become ready in time';
        exit 1;
      "

networks:
  yt-test:
    driver: bridge
