services:
  yt-api-mock:
    image: ghcr.io/yuge42/yt-api-mock/server:dev-d0618fd
    ports:
      - "50051:50051"
    environment:
      - LOG_LEVEL=info
    healthcheck:
      # Note: nc is not available in this image version, so we check if the server process is running
      # The reference implementation uses: ["CMD", "sh", "-c", "nc -z localhost 50051 || exit 1"]
      test: ["CMD", "sh", "-c", "kill -0 1 || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - yt-test

  tests:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    depends_on:
      yt-api-mock:
        condition: service_healthy
    environment:
      - SERVER_ADDRESS=yt-api-mock:50051
      - FETCHER_BINARY=/fetcher/yt-comment-fetcher
    networks:
      - yt-test
    volumes:
      - ./reports:/tests/reports
      - ./logs:/tests/logs

networks:
  yt-test:
    driver: bridge
